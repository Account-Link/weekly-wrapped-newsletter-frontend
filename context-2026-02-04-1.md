# 核心上下文总结 (2026-02-04)

## 1. 任务概述
本次会话主要完成了以下任务：
1.  **Bug 修复**：解决 Safari 浏览器中 TikTok 授权链接因弹窗拦截无法打开的问题。
2.  **功能增强**：优化邀请按钮的分享逻辑，优先使用系统原生分享（iOS/Android），不支持时自动降级。
3.  **UI/UX 改进**：集成全局 Toast 组件，替换原有的 alert 和局部错误提示。

## 2. 变更详情

### 2.1 Safari 弹窗拦截修复 (`InviteFlow.tsx`)
-   **问题**：Safari 限制在非用户直接交互的异步回调中调用 `window.open`。
-   **解决方案**：
    -   在点击事件处理函数 `handleConnect` 的**第一行**（同步代码块）立即调用 `window.open('', '_blank')` 打开一个空白/加载窗口。
    -   在异步轮询获取到重定向 URL 后，通过修改该窗口的 `location.href` 进行跳转。
    -   如果轮询失败或超时，自动关闭该预打开的窗口。
    -   添加了弹窗被完全拦截时的检测和 Toast 提示。

### 2.2 邀请按钮分享优化 (`InviteFlow.tsx`)
-   **功能**：实现了 `handleInvite` 函数。
-   **逻辑**：
    -   **Web Share API**：优先检测 `navigator.share`，如果支持（iOS/Android 主流浏览器），则呼起系统原生分享面板（Share Sheet）。
    -   **降级策略**：如果不支持 `navigator.share`，则自动回退到 `navigator.clipboard.writeText` 复制链接，并弹出 Toast 提示“Link copied to clipboard!”。

### 2.3 全局 Toast 组件
-   **组件**：`src/components/ui/Toast.tsx`（黑色半透明、顶部居中、自动关闭）。
-   **Context**：`src/context/ToastContext.tsx`。
-   **集成**：已在 `InviteFlow` 和 `UnsubscribeContent` 中全面应用。

## 3. 技术要点
-   **Window Management**：使用“预开窗 + 后跳转”模式绕过浏览器弹窗拦截。
-   **Web APIs**：使用了 `Navigator.share` 和 `Navigator.clipboard`。
-   **React Refs**：使用 `useRef` 追踪重定向状态，防止 React StrictMode 下的副作用重复执行。

## 4. 文件清单
-   `app/invite/InviteFlow.tsx`: 核心逻辑修改（授权+分享）。
-   `src/components/ui/Toast.tsx`: 新增 Toast 组件。
-   `src/context/ToastContext.tsx`: Toast 状态管理。
-   `app/layout.tsx`: 集成 ToastProvider。
